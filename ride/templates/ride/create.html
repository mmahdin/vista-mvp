{% extends 'base.html' %}
{% load static %}

{% block title %}Book a Ride{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.css" />
<style>
    .ride-container {
        padding-top: 2rem;
        padding-bottom: 3rem;
    }
    
    .map-container {
        height: 450px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    #map {
        height: 100%;
        width: 100%;
        z-index: 1;
    }
    
    .location-controls {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }
    
    .location-input {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        width: 100%;
        transition: all 0.3s;
        font-size: 1rem;
    }
    
    .location-input:focus {
        border-color: #4361ee;
        outline: none;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    .input-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
    }
    
    .input-wrapper {
        position: relative;
        margin-bottom: 1rem;
    }
    
    .location-btn {
        background: #4361ee;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
    }
    
    .location-btn:hover {
        background: #3a56d4;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
    }
    
    .location-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .btn-icon {
        margin-right: 8px;
    }
    
    .form-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1.25rem;
        color: #1e293b;
    }
    
    .btn-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .btn-option {
        flex: 1;
        min-width: 120px;
    }
    
    .btn-check:checked + .btn-option {
        background: #4361ee;
        color: white;
        border-color: #4361ee;
    }
    
    .btn-option i {
        margin-right: 8px;
    }
    
    .divider {
        height: 1px;
        background: #e2e8f0;
        margin: 1.5rem 0;
    }
    
    .summary-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1.5rem;
        border-left: 4px solid #4361ee;
    }
    
    .summary-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #1e293b;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    
    .summary-label {
        color: #64748b;
    }
    
    .summary-value {
        font-weight: 500;
    }
    
    .total {
        font-weight: 700;
        font-size: 1.25rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px dashed #cbd5e1;
    }
    
    .submit-btn {
        background: #10b981;
        color: white;
        border: none;
        border-radius: 12px;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        width: 100%;
        transition: all 0.3s;
        margin-top: 1.5rem;
    }
    
    .submit-btn:hover {
        background: #059669;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .submit-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .marker-pin {
        width: 30px;
        height: 30px;
        border-radius: 50% 50% 50% 0;
        background: #4361ee;
        position: absolute;
        transform: rotate(-45deg);
        left: 50%;
        top: 50%;
        margin: -15px 0 0 -15px;
    }
    
    .marker-pin::after {
        content: '';
        width: 24px;
        height: 24px;
        margin: 3px 0 0 3px;
        background: white;
        position: absolute;
        border-radius: 50%;
    }
    
    .destination-pin {
        background: #ef4444;
    }
    
    .leaflet-popup-content {
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container ride-container">
    <div class="row">
        <div class="col-lg-8">
            <div class="card form-card">
                <h1 class="h2 mb-4">Book Your Ride</h1>
                
                <div class="map-container">
                    <div id="map"></div>
                </div>
                
                <div class="location-controls">
                    <div class="input-wrapper">
                        <i class="fas fa-circle-dot input-icon"></i>
                        <input type="text" id="origin-input" class="location-input" placeholder="Enter pickup location">
                    </div>
                    
                    <div class="input-wrapper">
                        <i class="fas fa-location-dot input-icon"></i>
                        <input type="text" id="destination-input" class="location-input" placeholder="Enter destination">
                    </div>
                    
                    <button id="locate-btn" class="location-btn">
                        <i class="fas fa-location-crosshairs btn-icon"></i>Use Current Location
                    </button>
                </div>
                
                <form method="post" id="booking-form">
                    {% csrf_token %}
                    
                    <div class="form-card">
                        <h2 class="form-title">Ride Options</h2>
                        <div class="btn-group">
                            {% for value, label in form.ride_type.field.choices %}
                            <input type="radio" class="btn-check" name="ride_type" id="ride-{{ value }}" value="{{ value }}" 
                                {% if forloop.first %}checked{% endif %}>
                            <label class="btn btn-outline-primary btn-option" for="ride-{{ value }}">
                                {% if value == 'standard' %}
                                <i class="fas fa-car"></i>
                                {% elif value == 'premium' %}
                                <i class="fas fa-crown"></i>
                                {% elif value == 'group' %}
                                <i class="fas fa-users"></i>
                                {% elif value == 'cargo' %}
                                <i class="fas fa-box"></i>
                                {% endif %}
                                {{ label }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="form-card">
                        <h2 class="form-title">Payment Method</h2>
                        <div class="btn-group">
                            {% for value, label in form.payment_method.field.choices %}
                            <input type="radio" class="btn-check" name="payment_method" id="pay-{{ value }}" value="{{ value }}" 
                                {% if forloop.first %}checked{% endif %}>
                            <label class="btn btn-outline-primary btn-option" for="pay-{{ value }}">
                                {% if value == 'credit' %}
                                <i class="fas fa-credit-card"></i>
                                {% elif value == 'wallet' %}
                                <i class="fas fa-wallet"></i>
                                {% elif value == 'cash' %}
                                <i class="fas fa-money-bill-wave"></i>
                                {% endif %}
                                {{ label }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="form-card">
                        <h2 class="form-title">Special Instructions</h2>
                        {{ form.notes }}
                    </div>
                    
                    <!-- Hidden fields for coordinates -->
                    {{ form.origin_lat }}
                    {{ form.origin_lng }}
                    {{ form.destination_lat }}
                    {{ form.destination_lng }}
                    
                    <button type="submit" id="submit-btn" class="submit-btn" disabled>
                        <i class="fas fa-taxi me-2"></i>Confirm & Book Ride
                    </button>
                </form>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="summary-card">
                <h3 class="summary-title">Ride Summary</h3>
                
                <div class="summary-item">
                    <span class="summary-label">Pickup Location:</span>
                    <span id="origin-summary" class="summary-value">-</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Destination:</span>
                    <span id="destination-summary" class="summary-value">-</span>
                </div>
                
                <div class="divider"></div>
                
                <div class="summary-item">
                    <span class="summary-label">Ride Type:</span>
                    <span id="ride-type-summary" class="summary-value">Standard</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Distance:</span>
                    <span id="distance-summary" class="summary-value">-</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Estimated Time:</span>
                    <span id="time-summary" class="summary-value">-</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Base Fare:</span>
                    <span id="base-fare" class="summary-value">$5.00</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Distance Fare:</span>
                    <span id="distance-fare" class="summary-value">$0.00</span>
                </div>
                
                <div class="summary-item">
                    <span class="summary-label">Service Fee:</span>
                    <span id="service-fee" class="summary-value">$1.50</span>
                </div>
                
                <div class="summary-item total">
                    <span class="summary-label">Total:</span>
                    <span id="total-fare" class="summary-value">$6.50</span>
                </div>
            </div>
            
            <div class="card form-card">
                <h2 class="form-title">Driver Information</h2>
                <div class="text-center">
                    <img src="https://ui-avatars.com/api/?name=Driver+Demo&background=4361ee&color=fff&size=120" 
                         class="rounded-circle mb-3" alt="Driver">
                    <h4 class="mb-1">Alex Johnson</h4>
                    <div class="d-flex justify-content-center mb-2">
                        <span class="badge bg-primary me-2">4.9 ★</span>
                        <span class="badge bg-secondary">245 rides</span>
                    </div>
                    <p class="text-muted">Toyota Camry - ABC123</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.js"></script>
<script>
    // Initialize the map
    const map = L.map('map').setView([40.7128, -74.0060], 13); // Default to New York
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Create custom markers
    const originIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="marker-pin"></div>',
        iconSize: [30, 42],
        iconAnchor: [15, 42]
    });
    
    const destinationIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div class="marker-pin destination-pin"></div>',
        iconSize: [30, 42],
        iconAnchor: [15, 42]
    });
    
    // Initialize markers
    let originMarker = null;
    let destinationMarker = null;
    let routeLayer = null;
    
    // Elements
    const originInput = document.getElementById('origin-input');
    const destinationInput = document.getElementById('destination-input');
    const locateBtn = document.getElementById('locate-btn');
    const submitBtn = document.getElementById('submit-btn');
    const originSummary = document.getElementById('origin-summary');
    const destinationSummary = document.getElementById('destination-summary');
    const distanceSummary = document.getElementById('distance-summary');
    const timeSummary = document.getElementById('time-summary');
    
    // Form fields
    const originLatField = document.getElementById('id_origin_lat');
    const originLngField = document.getElementById('id_origin_lng');
    const destLatField = document.getElementById('id_destination_lat');
    const destLngField = document.getElementById('id_destination_lng');
    
    // Search controls
    const originSearch = new L.Control.Search({
        position: 'topright',
        layer: L.featureGroup(),
        initial: false,
        zoom: 17,
        marker: false,
        textPlaceholder: 'Search for pickup...'
    });
    map.addControl(originSearch);
    
    const destinationSearch = new L.Control.Search({
        position: 'topright',
        layer: L.featureGroup(),
        initial: false,
        zoom: 17,
        marker: false,
        textPlaceholder: 'Search for destination...'
    });
    map.addControl(destinationSearch);
    
    // Set up event listeners
    originInput.addEventListener('input', function() {
        originSearch.searchText(originInput.value);
    });
    
    destinationInput.addEventListener('input', function() {
        destinationSearch.searchText(destinationInput.value);
    });
    
    // Handle location selection from search
    map.on('search:locationfound', function(e) {
        const inputId = e.layer.options.inputId;
        
        if (inputId === 'origin') {
            placeOriginMarker(e.latlng, e.text);
        } else if (inputId === 'destination') {
            placeDestinationMarker(e.latlng, e.text);
        }
        
        if (originMarker && destinationMarker) {
            drawRoute();
            updateSummary();
            submitBtn.disabled = false;
        }
    });
    
    // Place origin marker
    function placeOriginMarker(latlng, locationName) {
        if (originMarker) {
            map.removeLayer(originMarker);
        }
        
        originMarker = L.marker(latlng, {
            icon: originIcon,
            draggable: true
        }).addTo(map);
        
        originMarker.bindPopup(`<b>Pickup:</b><br>${locationName}`).openPopup();
        originInput.value = locationName;
        originSummary.textContent = locationName;
        
        originLatField.value = latlng.lat;
        originLngField.value = latlng.lng;
        
        // Update marker position when dragged
        originMarker.on('dragend', function(e) {
            const newLatLng = e.target.getLatLng();
            originLatField.value = newLatLng.lat;
            originLngField.value = newLatLng.lng;
            if (destinationMarker) {
                drawRoute();
                updateSummary();
            }
        });
    }
    
    // Place destination marker
    function placeDestinationMarker(latlng, locationName) {
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
        }
        
        destinationMarker = L.marker(latlng, {
            icon: destinationIcon,
            draggable: true
        }).addTo(map);
        
        destinationMarker.bindPopup(`<b>Destination:</b><br>${locationName}`).openPopup();
        destinationInput.value = locationName;
        destinationSummary.textContent = locationName;
        
        destLatField.value = latlng.lat;
        destLngField.value = latlng.lng;
        
        // Update marker position when dragged
        destinationMarker.on('dragend', function(e) {
            const newLatLng = e.target.getLatLng();
            destLatField.value = newLatLng.lat;
            destLngField.value = newLatLng.lng;
            if (originMarker) {
                drawRoute();
                updateSummary();
            }
        });
    }
    
    // Draw route between markers
    function drawRoute() {
        // Remove existing route if present
        if (routeLayer) {
            map.removeLayer(routeLayer);
        }
        
        // Create a polyline between markers
        routeLayer = L.polyline([
            originMarker.getLatLng(),
            destinationMarker.getLatLng()
        ], {
            color: '#4361ee',
            weight: 5,
            opacity: 0.7,
            dashArray: '10, 10'
        }).addTo(map);
        
        // Fit map to show both markers
        const bounds = L.latLngBounds([
            originMarker.getLatLng(),
            destinationMarker.getLatLng()
        ]);
        map.fitBounds(bounds, {padding: [50, 50]});
    }
    
    // Update ride summary
    function updateSummary() {
        const originLatLng = originMarker.getLatLng();
        const destLatLng = destinationMarker.getLatLng();
        
        // Calculate distance (simplified - in a real app, use routing service)
        const distance = calculateDistance(
            originLatLng.lat, originLatLng.lng,
            destLatLng.lat, destLatLng.lng
        );
        
        const distanceKm = (distance / 1000).toFixed(1);
        distanceSummary.textContent = `${distanceKm} km`;
        
        // Calculate time (simplified)
        const timeMinutes = Math.round(distance / 200); // 200m per minute
        timeSummary.textContent = `${timeMinutes} min`;
        
        // Update fare calculation
        const baseFare = 5.00;
        const distanceFare = distanceKm * 1.5;
        const serviceFee = 1.50;
        const totalFare = baseFare + distanceFare + serviceFee;
        
        document.getElementById('distance-fare').textContent = `$${distanceFare.toFixed(2)}`;
        document.getElementById('total-fare').textContent = `$${totalFare.toFixed(2)}`;
    }
    
    // Calculate distance between two points (Haversine formula)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Earth radius in meters
        const φ1 = lat1 * Math.PI/180;
        const φ2 = lat2 * Math.PI/180;
        const Δφ = (lat2-lat1) * Math.PI/180;
        const Δλ = (lon2-lon1) * Math.PI/180;
        
        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                  Math.cos(φ1) * Math.cos(φ2) *
                  Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        
        return R * c; // Distance in meters
    }
    
    // Use current location
    locateBtn.addEventListener('click', function() {
        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser");
            return;
        }
        
        locateBtn.disabled = true;
        locateBtn.innerHTML = '<i class="fas fa-spinner fa-spin btn-icon"></i>Locating...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const latlng = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // Reverse geocode to get location name
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`)
                    .then(response => response.json())
                    .then(data => {
                        const locationName = data.display_name || 'Current Location';
                        placeOriginMarker(latlng, locationName);
                        locateBtn.disabled = false;
                        locateBtn.innerHTML = '<i class="fas fa-location-crosshairs btn-icon"></i>Use Current Location';
                    })
                    .catch(error => {
                        placeOriginMarker(latlng, 'Current Location');
                        locateBtn.disabled = false;
                        locateBtn.innerHTML = '<i class="fas fa-location-crosshairs btn-icon"></i>Use Current Location';
                    });
            },
            function(error) {
                alert(`Unable to get your location: ${error.message}`);
                locateBtn.disabled = false;
                locateBtn.innerHTML = '<i class="fas fa-location-crosshairs btn-icon"></i>Use Current Location';
            }
        );
    });
    
    // Update ride type summary when selection changes
    document.querySelectorAll('input[name="ride_type"]').forEach(input => {
        input.addEventListener('change', function() {
            document.getElementById('ride-type-summary').textContent = 
                this.nextElementSibling.textContent.trim();
        });
    });
    
    // Initialize search controls
    originSearch.on('search:collapsed', function(e) {
        originSearch.options.layer = L.featureGroup();
        originSearch.options.inputId = 'origin';
    });
    
    destinationSearch.on('search:collapsed', function(e) {
        destinationSearch.options.layer = L.featureGroup();
        destinationSearch.options.inputId = 'destination';
    });
</script>
{% endblock %}