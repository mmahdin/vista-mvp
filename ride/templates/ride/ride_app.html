<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Your Ride</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 1rem;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        #map {
            height: 500px; /* Increased height */
            width: 100%;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                        0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .other-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                        0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                        0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            text-align: center;
            display: none;
        }

        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-3xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Book Your Ride</h1>

        <div id="map" class="mb-6"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h2 class="text-xl font-semibold text-blue-700 mb-2">Origin</h2>
                <p id="origin-display" class="text-gray-700">Click on the map to set origin</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <h2 class="text-xl font-semibold text-green-700 mb-2">Destination</h2>
                <p id="destination-display" class="text-gray-700">Click on the map to set destination</p>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4">
            <button id="use-current-location-btn"
                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                Use Current Location
            </button>
            <button id="request-ride-btn" disabled
                    class="flex-1 bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                Request Ride
            </button>
        </div>
    </div>

    <div id="message-box-overlay" class="message-box-overlay"></div>
    <div id="message-box" class="message-box">
        <p id="message-box-text" class="text-lg font-medium text-gray-800 mb-4"></p>
        <button id="message-box-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">OK</button>
    </div>

    <script>
        // Function to show a custom message box
        function showMessageBox(message) {
            const messageBox = document.getElementById('message-box');
            const messageBoxOverlay = document.getElementById('message-box-overlay');
            document.getElementById('message-box-text').textContent = message;
            messageBox.style.display = 'block';
            messageBoxOverlay.style.display = 'block';
        }

        // Function to hide the custom message box
        function hideMessageBox() {
            const messageBox = document.getElementById('message-box');
            const messageBoxOverlay = document.getElementById('message-box-overlay');
            messageBox.style.display = 'none';
            messageBoxOverlay.style.display = 'none';
        }

        document.getElementById('message-box-close-btn').addEventListener('click', hideMessageBox);
        document.getElementById('message-box-overlay').addEventListener('click', hideMessageBox); // Close on overlay click

        let map;
        let originMarker, destinationMarker;
        let originLocation = null;
        let destinationLocation = null;

        // Initialize the map on window load
        window.onload = function() {
            map = L.map('map').setView([35.972447, 50.732428], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // IMPORTANT: Invalidate map size after it's added to the DOM and has a size.
            // This is crucial when the map container's dimensions might not be immediately available
            // or if it's within a flex/grid container.
            map.invalidateSize();

            // Add a click event listener to the map
            map.on('click', onMapClick);

            // Event listener for "Use Current Location" button
            document.getElementById('use-current-location-btn').addEventListener('click', useCurrentLocation);

            // Event listener for "Request Ride" button
            document.getElementById('request-ride-btn').addEventListener('click', requestRide);

            // Try to get current location immediately if possible
            // if (navigator.geolocation) {
            //     navigator.geolocation.getCurrentPosition(
            //         (position) => {
            //             const lat = position.coords.latitude;
            //             const lng = position.coords.longitude;
            //             map.setView([lat, lng], 15); // Center map on current location
            //             showMessageBox("Map centered on your current location.");
            //             map.invalidateSize(); // Invalidate size again after setting view
            //         },
            //         (error) => {
            //             console.error("Error getting current location:", error);
            //             showMessageBox("Could not get your current location. Please enable location services or click on the map.");
            //         },
            //         { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            //     );
            // } else {
            //     showMessageBox("Geolocation is not supported by your browser. Please click on the map to set locations.");
            // }
        };

        let clickCount = 0; // To alternate between origin and destination

        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            if (clickCount % 2 === 0) { // First click for origin
                if (originMarker) {
                    map.removeLayer(originMarker);
                }
                originLocation = { lat, lng };
                originMarker = L.marker([lat, lng]).addTo(map)
                    .bindPopup("<b>Origin</b><br>Lat: " + lat.toFixed(4) + "<br>Lng: " + lng.toFixed(4)).openPopup();
                document.getElementById('origin-display').textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                reverseGeocode(lat, lng, 'origin-display', 'Origin');
            } else { // Second click for destination
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                }
                destinationLocation = { lat, lng };
                destinationMarker = L.marker([lat, lng], { icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })}).addTo(map)
                    .bindPopup("<b>Destination</b><br>Lat: " + lat.toFixed(4) + "<br>Lng: " + lng.toFixed(4)).openPopup();
                document.getElementById('destination-display').textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                reverseGeocode(lat, lng, 'destination-display', 'Destination');
            }

            clickCount++;
            updateRequestButtonState();
        }

        function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // Set current location as origin
                        if (originMarker) {
                            map.removeLayer(originMarker);
                        }
                        originLocation = { lat, lng };
                        originMarker = L.marker([lat, lng]).addTo(map)
                            .bindPopup("<b>Your Current Location (Origin)</b><br>Lat: " + lat.toFixed(4) + "<br>Lng: " + lng.toFixed(4)).openPopup();
                        document.getElementById('origin-display').textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                        reverseGeocode(lat, lng, 'origin-display', 'Origin');

                        map.setView([lat, lng], 15); // Center map on current location
                        map.invalidateSize(); // Invalidate size after setting view and adding marker
                        showMessageBox("Your current location has been set as the origin.");
                        updateRequestButtonState();
                    },
                    (error) => {
                        console.error("Error getting current location:", error);
                        showMessageBox("Unable to get your current location. Please ensure location services are enabled.");
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                showMessageBox("Geolocation is not supported by your browser.");
            }
        }

        function updateRequestButtonState() {
            const requestButton = document.getElementById('request-ride-btn');
            if (originLocation && destinationLocation) {
                requestButton.disabled = false;
            } else {
                requestButton.disabled = true;
            }
        }

        async function reverseGeocode(lat, lng, displayElementId, type) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                const address = data.display_name || `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                document.getElementById(displayElementId).textContent = `${type}: ${address}`;
            } catch (error) {
                console.error("Error during reverse geocoding:", error);
                document.getElementById(displayElementId).textContent = `${type}: Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)} (Address lookup failed)`;
            }
        }

        function requestRide() {
            if (originLocation && destinationLocation) {
                const rideData = {
                    origin_lat: originLocation.lat,
                    origin_lng: originLocation.lng,
                    destination_lat: destinationLocation.lat,
                    destination_lng: destinationLocation.lng
                };

                fetch("/ride/api/submit/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify(rideData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        showMessageBox("Ride successfully requested!");
                        console.log("Ride ID:", data.ride_id);
                    } else {
                        showMessageBox("Failed to request ride.");
                    }
                });
            } else {
                showMessageBox("Please select both origin and destination on the map.");
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const trimmed = cookie.trim();
                    if (trimmed.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(trimmed.slice(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

    </script>
</body>
</html>